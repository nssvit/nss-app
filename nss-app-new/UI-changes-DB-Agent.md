# UI Changes Required After Database Schema Cleanup

**Generated by:** Database Agent
**Migration:** `0002_schema_cleanup.sql`
**Date:** 2026-02-14

---

## Summary of DB Changes Made

1. `events.event_date` column **DROPPED** (redundant with start_date/end_date)
2. `events.start_date` and `events.end_date` changed from `DATE` to `TIMESTAMP WITH TIME ZONE`
3. `event_participation.declared_hours` column **DROPPED** (source of truth is `events.declared_hours`)
4. 6 unused admin SQL functions **DROPPED** (Drizzle queries replace them)
5. Validations updated: `declaredHours` range now `1-240` (matches DB constraint)

---

## CRITICAL: Branch & Year Constants

The DB uses abbreviations. UI constants must match.

### File: `src/lib/constants.ts`

**BRANCHES** — Replace the current array:
```ts
// CURRENT (WRONG - doesn't match DB):
export const BRANCHES = [
  'Computer Science',
  'Information Technology',
  'Electronics',
  'Mechanical',
  'Civil',
  'Electrical',
  'Chemical',
] as const

// CORRECT (matches DB CHECK constraint):
export const BRANCHES = ['EXCS', 'CMPN', 'IT', 'BIO-MED', 'EXTC'] as const

// Add display name mapping:
export const BRANCH_DISPLAY_NAMES: Record<string, string> = {
  'EXCS': 'Electronics & Computer Science',
  'CMPN': 'Computer Engineering',
  'IT': 'Information Technology',
  'BIO-MED': 'Biomedical Engineering',
  'EXTC': 'Electronics & Telecommunication',
}
```

**YEARS** — Replace the current array:
```ts
// CURRENT (WRONG):
export const YEARS = [1, 2, 3, 4] as const

// CORRECT (matches DB CHECK constraint):
export const YEARS = ['FE', 'SE', 'TE'] as const

// Add display name mapping:
export const YEAR_DISPLAY_NAMES: Record<string, string> = {
  'FE': 'First Year (FE)',
  'SE': 'Second Year (SE)',
  'TE': 'Third Year (TE)',
}
```

### Affected UI Components:
- `src/components/auth/signup-form.tsx` — Branch and year dropdowns must use DB values as `value`, display names as labels
- `src/components/users/edit-user-modal.tsx` — Same: branch/year selects need DB values
- `src/components/volunteers/volunteers-page.tsx` — Branch column displays DB abbreviations, use `BRANCH_DISPLAY_NAMES` to show friendly names
- `src/components/users/view-user-modal.tsx` — Same
- `src/components/profile/profile-form.tsx` — Branch/year display fields
- `src/components/profile/profile-header.tsx` — Branch/year badges

---

## CRITICAL: Role Constants

The DB seeds 3 roles. UI defines 5. Align UI to DB.

### File: `src/lib/constants.ts`

```ts
// CURRENT (WRONG - roles don't exist in DB):
export const ROLES = {
  ADMIN: 'admin',
  PROGRAM_OFFICER: 'program_officer',
  EVENT_LEAD: 'event_lead',
  DOCUMENTATION_LEAD: 'documentation_lead',
  VOLUNTEER: 'volunteer',
} as const

// CORRECT (matches DB seed data):
export const ROLES = {
  ADMIN: 'admin',
  HEAD: 'head',
  VOLUNTEER: 'volunteer',
} as const

export const ROLE_HIERARCHY: Record<Role, number> = {
  [ROLES.ADMIN]: 100,
  [ROLES.HEAD]: 50,
  [ROLES.VOLUNTEER]: 10,
}

export const ROLE_DISPLAY_NAMES: Record<Role, string> = {
  [ROLES.ADMIN]: 'Administrator',
  [ROLES.HEAD]: 'NSS Head',
  [ROLES.VOLUNTEER]: 'Volunteer',
}

export const ROLE_COLORS: Record<Role, string> = {
  [ROLES.ADMIN]: 'bg-red-500/20 text-red-400',
  [ROLES.HEAD]: 'bg-purple-500/20 text-purple-400',
  [ROLES.VOLUNTEER]: 'bg-green-500/20 text-green-400',
}
```

**NOTE:** The hierarchy is now `higher number = more privilege` (matches DB: admin=100, head=50, volunteer=10). The `hasHigherOrEqualPrivilege` function logic needs to flip:
```ts
// CURRENT: lower number = higher privilege
return ROLE_HIERARCHY[userRole] <= ROLE_HIERARCHY[requiredRole]

// CORRECT: higher number = higher privilege
return ROLE_HIERARCHY[userRole] >= ROLE_HIERARCHY[requiredRole]
```

### Affected UI Components:
- `src/components/layout/nav-config.ts` — All `roles: ['program_officer', 'event_lead']` references need updating to `roles: ['admin', 'head']`
- `src/components/layout/sidebar.tsx` — Role filtering uses these constants
- `src/components/auth/protected-route.tsx` — `allowedRoles` checks
- `src/components/roles/role-management-page.tsx` — Role display
- `src/components/roles/assign-role-modal.tsx` — Role selection dropdown
- All page files using `ProtectedRoute` with `allowedRoles` prop:
  - `src/app/(dashboard)/attendance-manager/page.tsx`
  - `src/app/(dashboard)/categories/page.tsx`
  - `src/app/(dashboard)/hours-approval/page.tsx`
  - `src/app/(dashboard)/role-management/page.tsx`
  - `src/app/(dashboard)/user-management/page.tsx`

---

## CRITICAL: Event Status Constants

### File: `src/lib/constants.ts`

```ts
// CURRENT (WRONG - 'upcoming' doesn't exist in DB):
export const EVENT_STATUS = {
  PLANNED: 'planned',
  REGISTRATION_OPEN: 'registration_open',
  UPCOMING: 'upcoming',              // <-- NOT IN DB
  ONGOING: 'ongoing',
  COMPLETED: 'completed',
  CANCELLED: 'cancelled',
} as const

// CORRECT (matches DB CHECK constraint):
export const EVENT_STATUS = {
  PLANNED: 'planned',
  REGISTRATION_OPEN: 'registration_open',
  REGISTRATION_CLOSED: 'registration_closed',  // <-- REPLACES 'upcoming'
  ONGOING: 'ongoing',
  COMPLETED: 'completed',
  CANCELLED: 'cancelled',
} as const
```

Update the display names and colors maps to use `REGISTRATION_CLOSED` instead of `UPCOMING`.

### Affected UI Components:
- `src/components/events/event-status-badge.tsx` — Status badge colors
- `src/components/events/event-filters.tsx` — Status filter dropdown
- `src/components/events/event-form-modal.tsx` — Status select in form
- `src/components/events/event-registration.tsx` — Filters by `EVENT_STATUS.REGISTRATION_OPEN`
- `src/components/attendance/attendance-page.tsx` — Status filter

---

## CRITICAL: Participation Status Constants

### File: `src/lib/constants.ts`

Add the missing `excused` status (exists in DB CHECK):

```ts
// CORRECT:
export const PARTICIPATION_STATUS = {
  REGISTERED: 'registered',
  PRESENT: 'present',
  PARTIALLY_PRESENT: 'partially_present',
  ABSENT: 'absent',
  EXCUSED: 'excused',  // <-- ADD THIS (exists in DB)
} as const
```

Add display name and color for `excused`:
```ts
[PARTICIPATION_STATUS.EXCUSED]: 'Excused',
[PARTICIPATION_STATUS.EXCUSED]: 'bg-gray-500/20 text-gray-400',
```

---

## HIGH: Event Date Field Changes in Types

### File: `src/types/index.ts`

The `Event` and `EventWithStats` types need updating:

```ts
// REMOVE these fields:
eventDate: Date | string       // DROPPED from DB
startTime: string              // Was misnamed alias for start_date
endTime: string                // Was misnamed alias for end_date

// REPLACE with:
startDate: Date | string       // Now TIMESTAMP WITH TZ (was DATE)
endDate: Date | string         // Now TIMESTAMP WITH TZ (was DATE)
```

Also remove `hoursCredits` alias — use `declaredHours` directly to match DB:
```ts
// REMOVE:
hoursCredits: number

// USE:
declaredHours: number
```

The `EventParticipation` type — remove `declaredHours` (no longer in DB):
```ts
// REMOVE from EventParticipation:
declaredHours?: number
```

### Affected UI Components (that reference old field names):
- `src/components/events/event-card.tsx` — Uses `eventDate`, `hoursCredits`
- `src/components/events/event-form-modal.tsx` — Uses `eventDate`, `startTime`, `endTime`, `hoursCredits`
- `src/components/events/event-registration.tsx` — Uses `hoursCredits`
- `src/components/dashboard/volunteer-dashboard.tsx` — Uses `event_date`, `declared_hours`
- `src/components/dashboard/recent-events.tsx` — Uses `eventDate`
- `src/components/reports/top-events-table.tsx` — Uses `eventDate`
- `src/components/profile/profile-history.tsx` — Uses `event.eventDate`
- `src/components/attendance/attendance-page.tsx` — Uses `hoursCredits`
- `src/components/attendance/attendance-manager.tsx` — Uses `event_date`

---

## HIGH: Mapper Updates

### File: `src/lib/mappers.ts`

#### `mapEventRow` — Fix field mappings:
```ts
// CURRENT (BROKEN):
eventDate: r.event_date || r.start_date,  // event_date column no longer exists
startTime: r.start_date,                   // misleading field name
endTime: r.end_date,                       // misleading field name
hoursCredits: r.declared_hours ?? 0,       // alias; use declaredHours

// CORRECT:
startDate: r.start_date,
endDate: r.end_date,
declaredHours: r.declared_hours ?? 0,
```

#### `mapParticipationRow` — Fix hardcoded approvalStatus:
```ts
// CURRENT (BUG - always returns 'pending'):
approvalStatus: 'pending' as const,
approvedBy: null,
approvedAt: null,

// CORRECT (read from DB row):
approvalStatus: r.approval_status ?? 'pending',
approvedBy: r.approved_by ?? null,
approvedAt: r.approved_at ?? null,
```

**NOTE:** The `getVolunteerParticipationHistory` query in `src/db/queries/reports.ts` needs to SELECT `ep.approval_status`, `ep.approved_by`, `ep.approved_at` for this to work. Currently it doesn't select those columns. Add them to the query SELECT.

---

## MEDIUM: Server Action Updates

### File: `src/app/actions/events.ts`

The `createEvent` action must:
1. Accept `startDate` and `endDate` as Date/ISO string (not separate date + time strings)
2. Remove any `eventDate` field handling
3. Pass `new Date(startDate)` and `new Date(endDate)` to the query

### File: `src/app/actions/attendance.ts`

Remove any `declaredHours` parameter passing to `registerForEvent` query. The query signature changed from `registerForEvent(eventId, volunteerId, declaredHours)` to `registerForEvent(eventId, volunteerId)`.

### File: `src/app/actions/hours.ts`

The `mapParticipationRow` fix above will also affect this — ensure the hours page actually reads `approvalStatus` from DB instead of the hardcoded `'pending'`.

---

## MEDIUM: Event Form Modal Redesign

### File: `src/components/events/event-form-modal.tsx`

The form currently has separate `eventDate`, `startTime`, `endTime` fields. After this migration:

- Replace with: **Start Date/Time** picker (single datetime-local input) and **End Date/Time** picker
- For single-day events (4-6 hours): same date, different times
- For multi-day camps: different dates and times
- Remove `hoursCredits` field label, rename to `declaredHours` with range 1-240

Example form fields:
```tsx
<input type="datetime-local" name="startDate" />
<input type="datetime-local" name="endDate" />
<input type="number" name="declaredHours" min={1} max={240} />
```

---

## LOW: Auth Context

### File: `src/contexts/auth-context.tsx`

The signup metadata sent to Supabase must use DB-compatible branch/year values:
```ts
// Currently sends whatever the form provides
// Ensure form sends: branch='CMPN', year='SE' (not 'Computer Engineering', '2')
```

The `handle_new_user()` trigger reads `raw_user_meta_data->>'branch'` and `raw_user_meta_data->>'year'` and inserts directly into the volunteers table. If the UI sends wrong values, the DB CHECK constraint will reject the insert and signup will fail silently.

---

## LOW: Reports Queries Return Type

### File: `src/app/actions/reports.ts` and `src/app/actions/dashboard.ts`

The reports queries now return `start_date` instead of `event_date` in their result rows. Any mapping code that reads `r.event_date` needs to read `r.start_date` instead.

---

## NO CHANGES NEEDED

These files don't need updates:
- `src/db/schema/volunteers.ts` — Branch/year CHECK constraints stay as-is
- `src/db/schema/eventCategories.ts` — No changes
- `src/db/schema/roleDefinitions.ts` — No changes
- `src/db/schema/userRoles.ts` — No changes
- `src/db/schema/relations.ts` — No changes (eventDate wasn't in relations)
- `src/db/queries/dashboard.ts` — Already uses `start_date` correctly
- `src/db/queries/volunteers.ts` — No event_date or declaredHours references
- `src/db/queries/roles.ts` — No changes needed
- `src/db/queries/hours.ts` — No event_date or participation.declaredHours references
- `src/components/categories/` — No affected fields
- `src/components/hours/` — Already uses correct field names
- `src/components/settings/` — No DB interaction

---

## Migration Checklist

1. [ ] Run `npm run db:setup` to apply migration 0002
2. [ ] Update `src/lib/constants.ts` (branches, years, roles, event status, participation status)
3. [ ] Update `src/types/index.ts` (Event, EventWithStats, EventParticipation types)
4. [ ] Update `src/lib/mappers.ts` (mapEventRow, mapParticipationRow)
5. [ ] Update `src/components/events/event-form-modal.tsx` (date/time fields)
6. [ ] Update `src/components/events/event-card.tsx` (field names)
7. [ ] Update `src/components/auth/signup-form.tsx` (branch/year values)
8. [ ] Update `src/components/users/edit-user-modal.tsx` (branch/year values)
9. [ ] Update all `ProtectedRoute` `allowedRoles` to use `['admin', 'head']`
10. [ ] Update `src/contexts/auth-context.tsx` (signup metadata)
11. [ ] Update `src/app/actions/events.ts` (createEvent params)
12. [ ] Update `src/app/actions/attendance.ts` (registerForEvent call)
13. [ ] Add `approval_status` columns to participation history query in `src/db/queries/reports.ts`
14. [ ] Test signup flow with DB branch/year values
15. [ ] Test event creation with new datetime fields
16. [ ] Test hours approval display (no more hardcoded 'pending')
